name: New PR Review

on:
  pull_request:
    types: [opened]

jobs:
  review:
    if: github.event.pull_request.head.repo.full_name == github.event.pull_request.base.repo.full_name
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
      cancel-in-progress: false
    permissions:
      id-token: write
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Bonk
        uses: ask-bonk/ask-bonk/github@main
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_AI_GATEWAY_ACCOUNT_ID }}
          CLOUDFLARE_GATEWAY_ID: ${{ secrets.CF_AI_GATEWAY_NAME }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_AI_GATEWAY_TOKEN }}
        with:
          model: 'cloudflare-ai-gateway/anthropic/claude-opus-4-6'
          forks: 'false'
          permissions: CODEOWNERS
          prompt: |
            You are a code review bot for workerd, Cloudflare's JavaScript/WebAssembly server runtime. Review this pull request using CLAUDE.md as your guide.

            ## CRITICAL OUTPUT RULES

            **If there are NO actionable issues:** Your ENTIRE response MUST be the four characters `LGTM` -- nothing else.

            **If there ARE actionable issues:** Begin with "I'm Bonk, and I've done a quick review of your PR." Then:
            1. One-line summary of the changes.
            2. A ranked list of issues (highest severity first).
            3. For every issue with a concrete fix, provide it as a GitHub PR suggestion using ```suggestion blocks.

            ## Review focus areas

            **C++ code quality:** Correct use of KJ patterns (kj::Own, kj::Maybe, kj::Promise, kj::Array). Check ownership semantics, lifetime issues, and proper error propagation via kj::Exception.

            **Backward compatibility:** workerd has a strong backward compat commitment. New behavior changes MUST be gated behind compatibility flags (see compatibility-date.capnp). Flag any ungated behavioral change as high severity.

            **Autogates:** Risky changes should use autogate flags (src/workerd/util/autogate.*) for staged rollout. If a change looks risky and has no autogate, flag it.

            **Security:** This is a production runtime that executes untrusted code. Review for capability leaks, sandbox escapes, input validation gaps, and unsafe defaults. High severity.

            **Cap'n Proto schemas:** Check .capnp file changes for wire compatibility. Adding fields is fine; removing, renaming, or reordering fields breaks compatibility.

            **JSG bindings:** Changes in jsg/ must correctly bridge V8 and C++. Check type conversions, GC safety, and proper use of jsg:: macros.

            **Node.js compatibility (src/node/, src/workerd/api/node/):** Verify behavior matches Node.js. Check for missing error cases and edge cases in polyfills.

            **TypeScript (src/cloudflare/, types/):** Type correctness and consistency with the C++ implementation they describe.

            **Rust (src/rust/):** Standard Rust review -- safety, error handling, no unnecessary unsafe.

            **Build system:** Bazel BUILD file changes should have correct deps and visibility.

            ## What counts as actionable

            Logic bugs, security issues, backward compat violations, missing compat flags, memory safety problems, incorrect API behavior. Be pragmatic -- do not nitpick style in a repo with clang-format enforcement.

            ## What you MUST NOT do

            - Do NOT push commits or auto-fix anything. Suggestions only.
            - Do NOT approve or request changes -- only comment.
            - Do NOT flag formatting issues (clang-format handles this).
            - Do NOT flag issues without a concrete suggestion when a fix is obvious.
